<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Thanh toán</title>
    <link rel="stylesheet" type="text/css" th:href="@{/assets/css/pay.css}"/>
    <link rel="icon" href="data:,">
</head>
<body>
    <div>
        <div class="main-screen">
            <div class="left-bar">
                <div class="name-of-func"><b>THANH TOÁN</b></div>
                <div class="cashier-infor">Thông tin thu ngân</div>
                <div class="details-inf">
                    <div class="cashier-inf">Tên: </div>
                    <div class="shift-info"></div>
                </div>
                <div class="btn-func">
                    <div class="add-btn">Danh sách hoá đơn</div>
                    <div>Thoát</div>
                </div>
                <div class="choosetable-to-delete">
                    <div class="search-table-id">
                        <div><b>Nhập Table ID</b></div>
                        <input type="text" id="search-table-id">
                    </div>
                </div>
            </div>
            <div class="right-bar">
                <div class="delete-table">DANH SÁCH HÓA ĐƠN</div>
                <div class="table-screen">
                     <table>
                        <thead>
                            <tr>
                                <th>Invoice ID</th>
                                <th>Table ID</th>
                                <th>Total</th>
                                <th>Function</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr th:each="invoice : ${invoices}">
                                <td th:text="${invoice.invoiceId}"></td>
                                <td th:text="${invoice.table.tableId}"></td>
                                <td th:text="${invoice.sum} + 'đ'"></td>
                                <td>
                                    <a class="edit-button" th:href="@{/homepage-admin/detail-invoice/{id}(id=${invoice.invoiceId})}">Chi tiết</a>
                                    <button class="delete-button" th:onclick="'confirmPayment(' + ${invoice.invoiceId} + ')'" >Thanh toán</button>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="clear-fix"></div>
        </div>
    </div>
    <script type="text/javascript">
        document.addEventListener('DOMContentLoaded', function () {
            const fullname = localStorage.getItem("fullname");
            if (fullname) {
                document.querySelector('.cashier-inf').textContent = `Tên: ${fullname}`;
            }

            const currentTime = new Date();
            const currentHour = currentTime.getHours();
            let shift = '';
            if (currentHour >= 6 && currentHour < 12) {
                shift = "Sáng";
            } else if (currentHour >= 12 && currentHour < 18) {
                shift = "Chiều";
            } else {
                shift = "Tối";
            }
            document.querySelector('.shift-info').textContent = `Ca làm việc: ${shift}`;

            const inputField = document.getElementById('search-table-id');
            const tbody = document.querySelector('.table-screen tbody');

            inputField.addEventListener('input', function () {
                const tableId = inputField.value;

                fetch(`/homepage-admin/manage-account/search-invoice?tableId=${encodeURIComponent(tableId)}`)
                    .then(response => response.json())
                    .then(data => {
                        tbody.innerHTML = '';

                        data.forEach(invoice => {
                            const row = document.createElement('tr');
                            row.innerHTML = `
                                <td>${invoice.invoiceId}</td>
                                <td>${invoice.table.tableId}</td>
                                <td>${invoice.sum}đ</td>
                                <td>
                                    <a class="edit-button" href="/homepage-admin/detail-invoice/${invoice.invoiceId}">Chi tiết</a>
                                    <button class="delete-button" onclick="confirmPayment(${invoice.invoiceId})">Thanh toán</button>
                                </td>
                            `;
                            tbody.appendChild(row);
                        });
                    })
                    .catch(error => {
                        console.error('Error fetching invoices:', error);
                    });
            });
        });

        function confirmPayment(invoiceId) {
            if (window.confirm("Bạn có chắc chắn muốn thanh toán cho hóa đơn này?")) {
                fetch(`/homepage-admin/manage-account/payment/${invoiceId}`, {
                    method: 'POST'
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert("Thanh toán thành công");
                        location.reload();
                    } else {
                        alert("Đã có lỗi xảy ra khi thanh toán");
                    }
                })
                .catch(error => {
                    alert("Đã có lỗi xảy ra");
                    console.error(error);
                });
            }
        }
    </script>
</body>
</html>